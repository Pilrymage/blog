{{ define "main" }}
  {{ $features := .Site.Params.features | default dict }}
  {{ $searchEnabled := default false $features.search }}
  <section class="content-section search-page">
    <header class="content-section__header">
      <h1>{{ .Title }}</h1>
      {{ with .Content }}
        <div class="section-lead">{{ . }}</div>
      {{ end }}
    </header>

    {{ if not $searchEnabled }}
      <p class="search-page__disabled">站内搜索功能尚未启用。请在配置中开启 <code>params.features.search</code>。</p>
    {{ else }}
      <form class="search-form" role="search">
        {{ $placeholder := .Params.placeholder | default "输入关键词进行搜索…" }}
        <label class="search-form__label" for="search-input">{{ $placeholder }}</label>
        <div class="search-form__field">
          <input
            id="search-input"
            type="search"
            class="search-form__input"
            data-search-input
            placeholder="{{ $placeholder }}"
            autocomplete="off"
            spellcheck="false"
            inputmode="search"
            aria-describedby="search-status">
          <button type="reset" class="search-form__clear" data-search-clear aria-label="清除搜索">
            &times;
          </button>
        </div>
      </form>
      <p id="search-status" class="search-page__status" data-search-status aria-live="polite"></p>
      <div class="search-results" data-search-wrapper>
        <p class="search-results__empty" data-search-empty hidden>暂时没有匹配的内容。</p>
        <ul class="search-results__list" data-search-results></ul>
      </div>
      <noscript>
        <p class="search-page__noscript">需要启用 JavaScript 才能使用搜索功能。</p>
      </noscript>
    {{ end }}
  </section>
{{ end }}

{{ define "extra_js" }}
  {{ $features := .Site.Params.features | default dict }}
  {{ if (default false $features.search) }}
    {{ $searchParams := .Site.Params.search | default dict }}
    {{ $indexPath := $searchParams.indexURL | default "index.json" }}
    {{ $config := dict
      "indexURL" (relLangURL $indexPath)
      "minLength" (or $searchParams.minLength 2)
      "debounce" (or $searchParams.debounce 180)
      "maxResults" (or $searchParams.maxResults 30)
      "messages" (dict
        "initial" "开始输入以检索文章。"
        "loading" "正在加载索引…"
        "minLength" (printf "请至少输入 %d 个字符。" (or $searchParams.minLength 2))
        "noResults" "没有找到匹配的文章。"
        "results" "共找到 %d 篇相关内容。"
        "error" "索引加载失败，请稍后再试。"
      )
    }}
    <script id="essence-search-config" type="application/json">{{ $config | jsonify | safeJS }}</script>
    {{ with resources.Get "js/search.js" }}
      {{ $opts := dict
        "targetPath" "js/search.js"
        "minify" (not hugo.IsDevelopment)
        "sourceMap" (cond hugo.IsDevelopment "external" "")
      }}
      {{ with . | js.Build $opts }}
        {{ if hugo.IsDevelopment }}
          <script src="{{ .RelPermalink }}"></script>
        {{ else }}
          {{ with . | fingerprint }}
            <script src="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
